<!DOCTYPE html>

<head>
  <title>Line Charts</title>
  <meta charset="utf-8">
  <!-- This is the linecharts.html given to us then merged in the tutorial -->
  <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
  <!-- <script type="text/javascript" src="../lib/d3-scale-chromatic.v1.min.js"></script> -->
  <style>

    .axis line {
        stroke: #706f6f;
        stroke-width: 0.5;
        shape-rendering: crispEdges;
        }
        
        /* axis contour */
        .axis path {
        stroke: #706f6f;
        stroke-width: 0.7;
        shape-rendering: crispEdges;
        }
        
        /* axis text */
        .axis text {
        fill: #2b2929;
        font-family: Georgia;
        font-size: 120%;
        }
    
        /* LINE CHART */
        path {
        fill: none;
        stroke: #ed3700;
        }
    
        /* LINE CHART */
        path.line-0 {
        fill: none;
        stroke: #00ed7e;
        }
        
        path.line-1 {
        fill: none;
        stroke: #2b2929;
        stroke-dasharray: 9;
        }
        
        path.line-2 {
        fill: none;
        stroke: #9c9c9c;
        stroke-dasharray: 6;
        }
    
        .serie_label {
            fill: #2b2929;
            font-family: Georgia;
            font-size: 80%;
            }
    
    </style>
</head>

<body>

  <div id="svg-a" class="svg-container"></div>
  <div id='signature'>dhislop3</div>
<script>

    //------------------------1. PREPARATION-------------------------//
    
    //-----------------------------SVG-------------------------------//
    const width = 960;
    const height = 500;
    const margin = 15;
    const padding = 15;
    const adj = 30;
    // we are appending SVG first
    const svg = d3.select("div#svg-a").append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "-"
              + adj + " -"
              + adj + " "
              + (width + adj *3) + " "
              + (height + adj*3))
        .style("padding", padding)
        .style("margin", margin)
        .classed("svg-content", true);
    //----------------------------TITLE------------------------------//
    d3.select("#svg-a").append("text")
        // .attr("class", "axis")
        .attr("id", "title-a")
        // .attr("x", width/2)
        // .attr("y", padding)
        // .attr("text-anchor", "middle")
        .text("Number of Ratings 2016-2020");
    
    //-----------------------------DATA------------------------------//
    const timeConv = d3.timeParse("%Y-%m-%d");
    const dataset = d3.csv("boardgame_ratings.csv");
    dataset.then(function(data) {
        const countess = data.columns.slice(1);
        const everyother = data.columns.slice(1)
            .filter((element, index, array) => {
                return index % 2 === 0;
            });
        
        const count_by_index = data.columns.slice(1)

            .map(function(id) {
                return {
                    id: id,
                    game: id.split("=")[0],
                    values: data.map(function(d){
                    return {
                        date: timeConv(d.date),
                        measurement: +d[id]
                    };
                })

                }
            })
            .filter((element, index, array) => {
                return index % 2 === 0
            });
        
        const rank_by_index = data.columns.slice(1)

            .map(function(id) {
                return {
                    id: id,
                    game: id.split("=")[0],
                    values: data.map(function(d){
                    return {
                        date: timeConv(d.date),
                        measurement: +d[id]
                    };
                })

                }
            })
            .filter((element, index, array) => {
                return index % 2 === 1
            });
        
        const slices = data.columns.slice(1)
            .map(function(id) {
            return {
                id: id,
                values: data.map(function(d){
                    return {
                        date: timeConv(d.date),
                        measurement: +d[id]
                    };
                })
            };
        });
        
    
        
        

    console.log("Countess", countess);
    console.log("everyother", everyother);
    console.log("count_by_index", count_by_index);
    console.log("rank_by_index", rank_by_index);
  
    console.log("Column headers", data.columns);
    console.log("Column headers without date", data.columns.slice(1));
    // returns the sliced dataset
    console.log("Slices",slices);  
    // returns the first slice
    console.log("First slice",slices[0]);
    // returns the array in the first slice
    console.log("B array",slices[1].values);   
    // returns the array in the third slice
    console.log("C array",slices[2].values);  
    // returns the date of the first row in the first slice
    console.log("Date element",slices[0].values[0].date);  
    // returns the array's length
    console.log("Array length",(slices[0].values).length);
    
    
    //----------------------------SCALES-----------------------------//
    const xScale = d3.scaleTime().range([0,width]);
    const yScale = d3.scaleLinear().rangeRound([height, 0]);
    xScale.domain(d3.extent(data, function(d){
        return timeConv(d.date)}));
    yScale.domain([(0), d3.max(slices, function(c) {
        return d3.max(c.values, function(d) {
            return d.measurement + 4; });
            })
        ]);
    
    //-----------------------------AXES------------------------------//
    // const yaxis = d3.axisLeft()
    //     .ticks((slices[0].values).length)
    //     // Need to set for every 10000
    //     .scale(yScale);
    
    const yaxis = d3.axisLeft()
        .ticks(10)
        // Need to set for every 10000
        .scale(yScale);

    const xaxis = d3.axisBottom()
        .ticks(d3.timeMonth.every(3))
        .tickFormat(d3.timeFormat('%b %y'))
        .scale(xScale);
    //----------------------------LINES------------------------------//
    const line = d3.line()
        .x(function(d) { return xScale(d.date); })
        .y(function(d) { return yScale(d.measurement); });
    
        let id = 0;
    var ids = function () {
        return "line-"+id++;
    }
    //-------------------------2. DRAWING----------------------------//
    d3.select("#svg-a").append("g")
        .attr("id", "plot-a")
    d3.select("#plot-a").append("g")
        .attr("id", "lines-a")
    //----------------------------LINES------------------------------//

   const lines =  d3.select("#lines-a").selectAll("lines")
        .attr("id", "lines-a")
        .data(count_by_index)
        .enter()
        .append("g");
    
        lines.append("path")
        .attr("class", ids)
        .attr("d", function(d) { return line(d.values); });
    
        lines.append("text")
        .attr("class","serie_label")
        .datum(function(d) {
            return {
                id: d.game,
                value: d.values[d.values.length - 4]}; })
        .attr("transform", function(d) {
                return "translate(" + (xScale(d.value.date) + 10)  
                + "," + (yScale(d.value.measurement) + 15 ) + ")";})
        .attr("x", 5)
        .text(function(d) { return d.id; });
    //-----------------------------AXES------------------------------//

    d3.select("#plot-a").append("g")
        .attr("id", "x-axis-a")
        .attr("class", "axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xaxis)
        .append("text")
        .attr("dx", ".75em")
        .attr("x", 999)
        .style("text-anchor", "end")
        .text("Month");
    
    d3.select("#plot-a").append("g")
        .attr("id", "y-axis-a")
        .attr("class", "axis")
        .call(yaxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("dy", ".75em")
        .attr("y", 6)
        .style("text-anchor", "end")
        .text("Num of Ratings");

    });
    </script>
</body>
