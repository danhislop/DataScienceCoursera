<!DOCTYPE html>
<head>
  <title>Games Rating: 2015 - 2019</title>
  <meta charset="utf-8">
  <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
  <!-- <script type="text/javascript" src="../lib/d3-dsv.min.js"></script> -->

  <style>

    .axis line {
        stroke: #706f6f;
        stroke-width: 0.5;
        shape-rendering: crispEdges;
        }
        
        /* axis contour */
        .axis path {
        stroke: #706f6f;
        stroke-width: 0.7;
        shape-rendering: crispEdges;
        }
        
        /* axis text */
        .axis text {
        fill: #2b2929;
        font-family: Georgia;
        font-size: 120%;
        }
    
        /* LINE CHART */
        path {
        fill: none;
        stroke: #ed3700;
        }
    
        /* LINE CHART */
        path.line-0 {
        fill: none;
        stroke: #00ed7e;
        }
        
        path.line-1 {
        fill: none;
        stroke: #2b2929;
        stroke-dasharray: 9;
        }
        
        path.line-2 {
        fill: none;
        stroke: #9c9c9c;
        stroke-dasharray: 6;
        }
    
        .serie_label {
            fill: #2b2929;
            font-family: Georgia;
            font-size: 80%;
            }
    
    </style>
</head>

<body>

<div id="container"></div>

<script>


    //------------------------BEGIN  B  B  BB  B  B    -------------------------//
    
    //-----------------------------SVG-------------------------------//
    const widthb = 960;
    const heightb = 500;
    const marginb = 15;
    const paddingb = 15;
    const adjb = 30;
    var margin = {top: 50, right: 50, bottom: 50, left: 50}

    // we are appending SVG A first
    var svgb = d3.select("div#svg-b").append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "-"
              + adjb + " -"
              + adjb + " "
              + (widthb + adjb *3) + " "
              + (heightb + adjb *3))
        .style("padding", paddingb)
        .style("margin", marginb)
        .classed("svg-content", true);
    //----------------------------TITLE------------------------------//
    svgb.append("text")
        // .attr("class", "axis")
        .attr("id", "title-b")
        // .attr("x", widthb/2)
        // .attr("y", paddingb)
        // .attr("text-anchor", "middle")
        .text("Number of Ratings 2016-2020 with Rankings");
    
    //-----------------------------DATA------------------------------//
    const timeConv = d3.timeParse("%Y");
    const dataset = d3.csv("average-rating.csv");
    dataset.then(function(data) {
    const countess = data.columns.slice(0);
    const everyother = data.columns.slice(1)
        .filter((element, index, array) => {
            return index % 2 === 1;
        });
    const mygamesx = ['Catan', 'Codenames', 'Terraforming Mars', 'Gloomhaven']
    const mygames = ['Catan=rank', 'Codenames=rank', 'Terraforming Mars=rank', 'Gloomhaven=rank']
    const rating_by_year = data.columns.slice(0)

        .map(function(id) {
            return {
                id: id,
                year: data.map(function(d){
                return {
                    date: timeConv(d.date),
                    measurement: +d[id]
                };
            })

            }
        })
        .filter((element, index, array) => {
            return index % 2 === 0
        });

        const count_by_index = data.columns.slice(1)

        .map(function(id) {
            return {
                id: id,
                game: id.split("=")[0],
                values: data.map(function(d){
                return {
                    date: timeConv(d.date),
                    measurement: +d[id]
                };
            })

            }
        })
        .filter((element, index, array) => {
            return index % 2 === 0
        });
    
    const rank_by_index = data.columns.slice(1)

        .map(function(id) {
            return {
                id: id,
                game: id.split("=")[0],
                values: data.map(function(d){
                return {
                    date: timeConv(d.date),
                    measurement: +d[id]
                };
            })

            }
        })
        .filter((element, index, array) => {
            return index % 2 === 1
        })
        .filter(x => mygames.includes(x.id))
            // to do: reduce to every third point
        // .filter((element, index, array) => {
        //     return element.index % 3 == 0
        // })
        ;
    
    const slices = data.columns.slice(1)
        .map(function(id) {
        return {
            id: id,
            values: data.map(function(d){
                return {
                    date: timeConv(d.date),
                    measurement: +d[id]
                };
            })
        };
    });
    
    
        
        
    console.log("countess", countess);
    console.log("rating_by_year", rating_by_year);
    console.log("mygames", mygames);
    console.log("everyother", everyother);
    console.log("count_by_index", count_by_index);
    console.log("rank_by_index", rank_by_index);
  
    console.log("Column headers", data.columns);
    console.log("Column headers without date", data.columns.slice(1));
    // returns the sliced dataset
    console.log("Slices",slices);  
    // returns the first slice
    console.log("First slice",slices[0]);
    // returns the array in the first slice
    console.log("B array",slices[1].values);   
    // returns the array in the third slice
    console.log("C array",slices[2].values);  
    // returns the date of the first row in the first slice
    console.log("Date element",slices[0].values[0].date);  
    // returns the array's length
    console.log("Array length",(slices[0].values).length);
    
    
    //----------------------------SCALES-----------------------------//

    var xScaleb = d3.scaleTime().range([0,widthb]);
    var yScaleb = d3.scaleLinear().rangeRound([heightb, 0]);
    xScaleb.domain(d3.extent(data, function(d){
        return timeConv(d.date)}));
    yScaleb.domain([(0), d3.max(slices, function(c) {
        return d3.max(c.values, function(d) {
            return d.measurement + 4; });
            })
        ]);
    
    //-----------------------------AXES------------------------------//
    var yaxisb = d3.axisLeft()
        .ticks(10)
        // Need to set for every 10000
        .scale(yScaleb);
    
    var xaxisb = d3.axisBottom()
        .ticks(d3.timeMonth.every(3))
        .tickFormat(d3.timeFormat('%b %y'))
        .scale(xScaleb);
    //----------------------------LINES------------------------------//
    var lineb = d3.line()
        .x(function(d) { return xScaleb(d.date); })
        .y(function(d) { return yScaleb(d.measurement); });
    
        let id = 0;
    var idsb = function () {
        return "line-"+id++;
    }
    
    //-------------------------2. DRAWING----------------------------//
    var plotb = svgb.append("g")
        .attr("id", "plot-b")
    var linesb = plotb.append("g")
        .attr("id", "lines-b")
    //----------------------------LINES------------------------------//

   var myColor = d3.scaleOrdinal(d3.schemeCategory10);
   var selectCircle = linesb.selectAll(".circle")
    .data(count_by_index)

    var lines = linesb.selectAll("lines")
        .attr("id", "lines-b")
        .data(count_by_index)
        .enter()
        .append("g");
    
        lines.append("path")
        .attr("class", idsb)
        .attr("d", function(d) { 
            return lineb(d.values); })
        .style("stroke", function(d, i){
            return myColor(i) })
        lines.append("text")
        .attr("class","serie_label")
        .datum(function(d) {
            return {
                id: d.game,
                value: d.values[d.values.length - 4]}; })
        .attr("transform", function(d) {
                return "translate(" + (xScaleb(d.value.date) + 10)  
                + "," + (yScaleb(d.value.measurement) + 15 ) + ")";})
        .attr("x", 5)
        .text(function(d) { return d.id; });
        
        //-----------------------------CIRCLES------------------------------//
    plotb.append("g")
        .attr("id", "symbols-b")
        .selectAll("dot")
        .data(rank_by_index)
        .enter()
        .append("circle")
            .attr("cx", function(d) {  
                return lineb(d.values.xScaleb) } )
            .attr("cy", function(d) { 
                console.log("THERE")
                return lineb(d.values.y) } )
            .attr("r", 5)
            .attr("fill", "#69b3a2")

        //-----------------------------AXES------------------------------//
    plotb.append("g")
        .attr("id", "x-axis-b")
        .attr("class", "axis")
        .attr("transform", "translate(0," + heightb + ")")
        .call(xaxisb)
        .append("text")
        .attr("dx", ".75em")
        .attr("x", 999)
        .style("text-anchor", "end")
        .text("Month");
    
    plotb.append("g")
        .attr("id", "y-axis-b")
        .attr("class", "axis")
        .call(yaxisb)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("dy", ".75em")
        .attr("y", 6)
        .style("text-anchor", "end")
        .text("Num of Ratings");

    });



    </script>

</body>
